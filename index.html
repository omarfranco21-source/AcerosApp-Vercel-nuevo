<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConstruApp: Catálogo y Pedidos</title>
    <!-- Carga Tailwind CSS para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos base para la aplicación */
        html, body, #root {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        /* Oculta la barra de desplazamiento en todos los navegadores */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <!-- Contenedor donde React inyectará la aplicación -->
    <div id="root" class="min-h-screen bg-gray-100 pb-20">
        <!-- Indicador de carga simple inicial -->
        <div class="flex items-center justify-center h-screen text-gray-500">Cargando aplicación...</div>
    </div>

    <!-- Módulos de Firebase y React -->
    <script type="module">
        // Importaciones de Firebase (para base de datos en tiempo real y autenticación)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Importaciones de React (necesarias para la lógica de la UI)
        import React, { useState, useEffect, useCallback } from 'https://esm.sh/react@18.3.1';
        import ReactDOM from 'https://esm.sh/react-dom@18.3.1/client';

        // --- Variables de Entorno (Obligatorias para el funcionamiento) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let isAuthReady = false;

        // --- FUNCIONES DE BASE DE DATOS Y UTILIDADES ---
        
        // Formato de moneda (Pesos Mexicanos)
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN',
                minimumFractionDigits: 2
            }).format(amount);
        };

        // Define la ruta de la colección pública (donde viven los materiales)
        const getPublicCollectionPath = (collectionName) => 
            `/artifacts/${appId}/public/data/${collectionName}`;

        // Función de inicialización y autenticación de Firebase
        const initFirebase = async (callback) => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase Config no está disponible.");
                    callback(false);
                    return;
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Autenticación usando el token de seguridad
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                console.log("Firebase: Inicializado y autenticado con éxito.");
                
                // Observador de estado para saber cuando el usuario está listo
                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    callback(true); // Indica que la inicialización y autenticación están listas
                });

            } catch (error) {
                console.error("Firebase: Error Crítico al inicializar o autenticar:", error);
                callback(false);
            }
        };

        // --- COMPONENTES DE REACT ---

        // Componente Principal de la Aplicación
        const App = () => {
            const [materiales, setMateriales] = useState([]);
            const [isAdmin, setIsAdmin] = useState(false);
            const [userId, setUserId] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);

            // 1. Inicialización de Firebase
            useEffect(() => {
                const forceRender = (success) => {
                    if (success) {
                        setIsLoading(true); 
                    } else {
                        setIsLoading(false);
                        setError("Error: No se pudo conectar a Firebase. Revisa la consola.");
                    }
                };

                if (!db) {
                    initFirebase(forceRender);
                }
            }, []);

            // 2. Establecer el usuario y verificar el rol de administrador
            useEffect(() => {
                if (auth && isAuthReady) {
                    const user = auth.currentUser;
                    const currentUserId = user ? user.uid : 'sin-usuario';
                    setUserId(currentUserId);
                    // Rol de Admin: ID específico para este ejemplo
                    setIsAdmin(currentUserId === 'admin-construapp-logic'); 
                }
            }, [isAuthReady]);

            // 3. Carga de datos de materiales en tiempo real
            useEffect(() => {
                // Solo si Firebase está listo y el usuario está autenticado
                if (db && isAuthReady && userId) {
                    const materialesPath = getPublicCollectionPath('materiales');
                    const
